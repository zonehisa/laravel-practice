# レジデータ自動入力システム 要件定義書

## 1. プロジェクト概要
本システムは、盛岡手づくり村の4台のPOSレジから出力される日々の売上データ（PDF形式）の集計作業を自動化し、事務スタッフの作業負担軽減とデータ入力の正確性向上を目的とする。

- **現状の課題 (As-Is):**
  - レジから出力されるPDFデータの内容を、毎日目視で確認しExcelへ手入力している。
  - この転記作業に毎日10～20分の時間がかかっている。
  - 手入力のため、転記ミスが発生するリスクが常にある。
- **導入後の理想 (To-Be):**
  - PDFファイルをアップロードするだけで、売上データが自動で集計されたExcelファイルが完成する。
  - 日々のルーティン作業が数分で完了し、大幅な時間削減が実現する。
  - 転記ミスがなくなり、データの正確性が向上する。
- **対象ユーザー:** 地場産業振興センターの事務スタッフ

## 2. ユーザーストーリー
「事務スタッフとして、【レジデータの集計作業を自動化したい】ので、【PDFファイルをアップロードするだけで、集計されたエクセルファイルがダウンロードできるようにしてほしい】」

## 3. 機能要件

| 優先度 | 機能分類 | 機能概要 |
| :--- | :--- | :--- |
| **Must** | PDFアップロード | 複数のレジデータPDFファイルを同時にアップロードできる機能。 |
| **Must** | データ抽出・集計 | PDFファイルから商品名、販売数、売上金額などのデータを自動で抽出し、集計する機能。 |
| **Must** | Excelダウンロード | 集計結果を整形したExcelファイルとしてダウンロードする機能。 |
| Could | 履歴保存 | 集計日時、対象ファイル名などの履歴を保存・管理する機能。（※DBが必要） |
| Could | 過去分ダウンロード | 履歴画面から過去に集計したExcelファイルを再ダウンロードできる機能。（※DBが必要） |
| Could | 売上グラフ表示 | 日別・月別の売上推移などをグラフで可視化するダッシュボード機能。 |

## 4. データ要件（PDFから抽出・集計する情報）
システムが処理すべき主要なデータ項目は以下の通り。

- 日付
- レジ番号
- 商品コード
- 商品名
- 単価
- 販売数
- 売上金額
- その他（割引、税情報など）

## 5. 実装詳細

### 5.1 必要なライブラリ
- **phpoffice/phpspreadsheet** (^5.2): Excelファイルの生成に使用
- **smalot/pdfparser** (^2.12): PDFファイルのテキスト抽出に使用

### 5.2 PDFファイル形式
- **ファイル形式**: PDF（.pdf）
- **PDF構造**: テキストベースのPDF（画像PDFは非対応）
- **レジ番号**: PDF内の「レジ番号：POS1」形式で記載
- **営業日**: 「営業日：令和 X年Y月Z日」形式で記載
- **商品データ**: 1行に2列の商品データが並ぶ形式

### 5.3 PDFデータ抽出仕様
PDFから抽出する情報の形式：

- **レジ番号抽出**: 正規表現 `/レジ番号[：:]\s*(POS\d+)/u` で抽出
- **営業日抽出**: 正規表現 `/営業日[：:]\s*令和\s*(\d+)年(\d+)月(\d+)日/u` で抽出し、西暦に変換（令和1年 = 2019年）
- **商品データ抽出**: 
  - 商品コード: `P\d+` 形式（例: P001, P002）
  - 商品名: 商品コードの後に続くテキスト
  - 単価: `¥[\d,]+` 形式（カンマ区切り数値）
  - 数量: 数値
  - 金額: `¥[\d,]+` 形式（カンマ区切り数値）
  - 1行に2列の商品が並ぶ場合、両方の商品を抽出

### 5.4 データ集計処理
- **商品コードごとの集計**: 同じ商品コードの数量と金額を合計
- **POSごとの集計**: 各POS（レジ）ごとに商品データを集計
- **全体集計**: すべてのPOSのデータを商品コードごとに集計
- **ソート**: 商品コードで昇順ソート

### 5.5 Excel出力仕様
- **ファイル名**: `register_data_YYYYMMDDHHmmss.xlsx`
- **ファイル形式**: Excel 2007以降形式（.xlsx）
- **シート構成**: 
  - POS1シート: POS1の商品データ
  - POS2シート: POS2の商品データ
  - POS3シート: POS3の商品データ
  - POS4シート: POS4の商品データ
  - 売上集計シート: 全POSの集計データ
- **シート順序**: POS番号で昇順ソート（POS1 → POS2 → POS3 → POS4 → 売上集計）

### 5.6 Excel列構成
各シートの列構成は以下の通り：

| 列 | 項目名 | 説明 | 形式 |
| :--- | :--- | :--- | :--- |
| A | 商品コード | 商品コード（P001形式） | 文字列 |
| B | 商品名 | 商品名 | 文字列 |
| C | 単価 | 商品単価 | 数値（カンマ区切り表示） |
| D | 販売数 | 販売数量 | 数値 |
| E | 売上金額 | 売上金額（単価×数量） | 数値（カンマ区切り表示） |

### 5.7 Excel書式設定
- **ヘッダー行**: 太字、背景色なし
- **数値形式**: 単価と売上金額はカンマ区切り表示（`#,##0`）
- **合計行**: 各シートの最終行に合計行を追加（太字）
- **列幅**: 自動調整

### 5.8 エラーハンドリング
- PDFファイルが存在しない、または読み込めない場合: エラーメッセージを表示
- PDFからテキストが抽出できない場合: エラーメッセージを表示
- レジ番号が抽出できない場合: デフォルトで「POS1」として処理
- 商品データが抽出できない場合: 空のシートを作成

### 5.9 技術スタック
- **フレームワーク**: Laravel 12
- **フロントエンド**: Livewire Volt 1
- **ファイルアップロード**: Livewire WithFileUploads（複数ファイル対応）
- **ファイル保存**: Laravel Storage (public disk)
