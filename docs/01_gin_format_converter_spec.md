# 全銀フォーマット自動変換システム 要件定義書

## 1. プロジェクト概要
本システムは、地場産業振興センターの事務スタッフが行う振込業務において、Excelで管理されている顧客情報を、銀行の一括振込用データ形式「全銀フォーマット（総合振込レコードフォーマット）」へ自動変換することを目的とする。

- **現状の課題 (As-Is):**
  - Excelの顧客情報を元に、全銀フォーマットのテキストデータを1件ずつ手作業で作成しており、時間がかかる。
  - 手作業による入力ミスが発生するリスクがあり、振込エラーの原因となる可能性がある。
- **導入後の理想 (To-Be):**
  - Excelファイルをアップロードするだけで、全銀協規定の総合振込レコードフォーマットに準拠したテキストファイルが即座に生成される。
  - 振込データ作成時間が大幅に短縮され、業務効率が向上する。
  - 手作業を排除することで入力ミスがなくなり、振込業務の正確性が担保される。
- **対象ユーザー:** 地場産業振興センターの事務スタッフ

## 2. ユーザーストーリー
「事務スタッフとして、【エクセルの顧客情報を全銀フォーマット（総合振込レコードフォーマット）に変換したい】ので、【ボタン一つで総合振込レコードフォーマットに対応したファイルを作成し、ダウンロードできるようにしてほしい】」

## 3. 機能要件

| 優先度 | 機能分類 | 機能概要 |
| :--- | :--- | :--- |
| **Must** | Excelアップロード | 振込先情報が記載された指定フォーマットのExcelファイルをアップロードする機能。 |
| **Must** | 総合振込レコードフォーマット変換 | アップロードされたデータを、全銀協規定の総合振込レコードフォーマット（固定長120バイト）に自動で変換する機能。 |
| **Must** | ファイルダウンロード | 変換後の総合振込レコードフォーマットファイル（.txt）をダウンロードする機能。 |
| Could | 変換履歴保存 | 変換日時、元ファイル名などの履歴を保存・管理する機能。（※DBが必要） |
| Could | 過去分ダウンロード | 履歴画面から過去に変換した総合振込レコードフォーマットファイルを再ダウンロードできる機能。（※DBが必要） |

## 4. データ要件（Excelから読み込む情報）
システムが変換処理のインプットとして必要とするデータ項目は以下の通り。

- 受取人名（カナ）
- 振込先銀行名、銀行コード
- 振込先支店名、支店コード
- 預金種別（普通、当座など）
- 口座番号
- 振込金額

## 5. 総合振込レコードフォーマット仕様

### 5.1 レコード構成
総合振込レコードフォーマットは、以下の4種類のレコードで構成されます（各レコードは120バイト固定長）：

1. **ヘッダ・レコード**：ファイルの先頭に位置し、データの概要を示します。
2. **データ・レコード**：各振込情報を含むレコードで、振込件数分存在します。
3. **トレーラ・レコード**：データ・レコードの後に位置し、データの総計などを示します。
4. **エンド・レコード**：ファイルの末尾に位置し、ファイルの終了を示します。

### 5.2 レコード詳細

#### ヘッダ・レコード（120バイト）
- レコード区分（1バイト）：1
- データ種別（2バイト）：21（総合振込）
- コード区分（1バイト）：0（全銀協コード）
- 委託者コード（10バイト）
- 委託者名（40バイト）
- 振込指定日（4バイト）：MMDD形式（月日）
- 振込元銀行番号（4バイト）
- 振込元支店番号（3バイト）
- 予備（55バイト）

#### データ・レコード（120バイト）
- レコード区分（1バイト）：2
- 振込先銀行番号（4バイト）
- 振込先支店番号（3バイト）
- 預金種目（1バイト）：1=普通、2=当座、4=納税準備預金
- 口座番号（7バイト）
- 受取人名（30バイト）：半角カナ
- 振込金額（10バイト）
- 新規コード（1バイト）：0=通常
- 顧客番号（20バイト）
- 振込区分（1バイト）
- 識別情報（7バイト）
- 預金者名（30バイト）
- 予備（5バイト）

#### トレーラ・レコード（120バイト）
- レコード区分（1バイト）：8
- データ件数（6バイト）
- 合計金額（12バイト）
- 予備（101バイト）

#### エンド・レコード（120バイト）
- レコード区分（1バイト）：9
- 予備（119バイト）

### 5.3 文字コード
- すべて半角文字を使用
- カナ文字は半角カナに変換
- ファイルエンコーディング：Shift_JIS

## 6. 実装詳細

### 6.1 必要なライブラリ
- **phpoffice/phpspreadsheet** (^5.2): Excelファイルの読み込みに使用
- **mbstring** (PHP標準拡張): Shift_JISへの文字コード変換、全角カナから半角カナへの変換に使用

### 6.2 Excelファイル形式
- **ファイル形式**: .xlsx, .xls
- **ヘッダー行**: 1行目にヘッダー情報が含まれる（処理時にスキップ）
- **データ行**: 2行目以降が振込データ

### 6.3 Excel列構成（実装確定事項）
システムが期待するExcelファイルの列順序は以下の通り（0始まりのインデックス）：

| 列番号 | 項目名 | 説明 |
| :--- | :--- | :--- |
| 0 | 顧客ID | 顧客番号として使用 |
| 1 | 事業者名 | - |
| 2 | 代表者氏名 | - |
| 3 | 郵便番号 | - |
| 4 | 住所 | - |
| 5 | 電話番号 | - |
| 6 | FAX番号 | - |
| 7 | メールアドレス | - |
| 8 | 契約日 | - |
| 9 | 契約区分 | - |
| 10 | 金融機関コード | 振込先銀行番号として使用 |
| 11 | 金融機関名 | - |
| 12 | 支店コード | 振込先支店番号として使用 |
| 13 | 支店名 | - |
| 14 | 預金種目 | 「普通」「当座」「納税準備預金」または数値（1, 2, 4） |
| 15 | 口座番号 | 振込先口座番号として使用 |
| 16 | 口座名義（カナ） | 受取人名（半角カナに変換）として使用 |
| 17 | 振込金額 | 振込金額として使用 |
| 18 | 振込予定日 | - |
| 19 | 備考 | - |
| 20 | 担当者 | - |
| 21 | 最終更新日 | - |

### 6.4 データ変換処理
- **預金種目の変換**: 
  - 「普通」または「1」→ 1
  - 「当座」または「2」→ 2
  - 「納税準備預金」または「4」→ 4
  - その他 → 1（デフォルト：普通預金）
- **カナ文字の変換**: 全角カナを半角カナに変換（`mb_convert_kana`を使用）
- **文字コード変換**: UTF-8からShift_JISに変換（`mb_convert_encoding`を使用）
- **固定長パディング**: 各フィールドはShift_JISのバイト長で120バイト固定長を確保

### 6.5 出力ファイル仕様
- **ファイル名**: `gin_format_YYYYMMDDHHmmss.txt`
- **ファイル形式**: テキストファイル（.txt）
- **文字コード**: Shift_JIS
- **改行コード**: LF（\n）
- **レコード長**: 各レコード120バイト固定長

### 6.6 エラーハンドリング
- Excelファイルが存在しない、または読み込めない場合: エラーメッセージを表示
- 必須項目が欠損している場合: 該当レコードをスキップ
- 文字コード変換エラー: エラーメッセージを表示

### 6.7 技術スタック
- **フレームワーク**: Laravel 12
- **フロントエンド**: Livewire Volt 1
- **ファイルアップロード**: Livewire WithFileUploads
- **ファイル保存**: Laravel Storage (public disk)
