# 委託精算書一括発行システム 要件定義書

## 1. プロジェクト概要
本システムは、地場産業振興センターの事務スタッフが毎月行っている委託販売精算書の作成業務を自動化し、業務負荷の軽減とデータ精度の向上を図ることを目的とする。

- **現状の課題 (As-Is):**
  - 約90の委託先に対し、複数のExcelデータを参照して精算書を手動で作成している。
  - 毎月25日に作業が集中し、月末の業務負荷が増大している。
  - 手作業のため、データ不整合や計算ミスが発生するリスクがある。
- **導入後の理想 (To-Be):**
  - ボタン操作一つで、全委託先向けの精算書が一括で自動生成される。
  - 精算書作成にかかる時間が大幅に削減され、月末の業務負荷が平準化される。
  - 人為的ミスが排除され、データの正確性が担保される。
- **対象ユーザー:** 地場産業振興センターの事務スタッフ

## 2. ユーザーストーリー
「事務スタッフとして、【複数のエクセルデータから精算書を一括で自動生成したい】ので、【ボタン一つで精算書が生成・ダウンロードできるようにしてほしい】」

## 3. 機能要件

| 優先度 | 機能分類 | 機能概要 |
| :--- | :--- | :--- |
| **Must** | ファイルアップロード | 売上データが含まれる複数のExcelファイルをアップロードする機能。 |
| **Must** | データ自動変換 | アップロードされたデータから精算書フォーマットに必要な情報を抽出し、自動でレイアウトする機能。 |
| **Must** | 一括生成・ダウンロード | 全委託先分の精算書を一括で生成し、PDFまたはExcel形式でダウンロードする機能。 |
| Could | 履歴保存 | 精算書の発行日時、対象期間、ファイル名などの履歴を保存・管理する機能。（※DBが必要） |
| Could | 過去分ダウンロード | 履歴画面から過去に発行した精算書を再ダウンロードできる機能。（※DBが必要） |

## 4. データ要件（精算書に含める情報）
システムが処理・出力すべきデータ項目は以下の通り。

- 委託先名、住所
- 請求期間
- 商品明細（商品名、単価、販売数、売上金額、手数料率、手数料額）
- 売上合計金額
- 手数料合計金額
- 支払合計金額
- 振込先情報

## 5. 実装作業記録

### 5.1 実装完了日
2025年1月（Must要件の実装完了）

### 5.2 使用ライブラリ・プラグイン
本機能の実装に使用したライブラリは以下の通りです。すべて既存のプロジェクトに含まれているため、追加インストールは不要でした。

- **phpoffice/phpspreadsheet** (^5.2)
  - Excelファイルの読み込み・書き込みに使用
  - 精算書のレイアウト生成（列幅、罫線、背景色、フォント設定など）に使用

- **livewire/volt** (^1.9)
  - ファイルアップロードUIの実装に使用
  - Livewire\WithFileUploadsトレイトを使用してファイルアップロード機能を実装

### 5.3 作成したファイル

#### サービスクラス
- `app/Services/ConsignmentInvoiceGeneratorService.php`
  - 顧客管理データと売上データの読み込み
  - データの結合と集計
  - 精算書の計算ロジック（小計、手数料、消費税、振込手数料、お支払金額）
  - Excel形式での精算書生成

#### Livewire Voltコンポーネント
- `resources/views/livewire/consignment-invoice-generator/index.blade.php`
  - ファイルアップロードUI（顧客管理データ、売上データ）
  - 精算書生成ボタン
  - エラーメッセージ表示
  - ダウンロードリンク表示

#### ルーティング
- `routes/web.php`
  - `/consignment-invoice-generator` - 精算書生成ページ
  - `/consignment-invoice-generator/download/{file}` - 生成されたExcelファイルのダウンロード

#### テストファイル
- `tests/Feature/ConsignmentInvoiceGeneratorTest.php`
  - ページ表示テスト
  - ファイル未選択時のエラーハンドリングテスト
  - 精算書生成テスト
  - データ結合テスト
  - 計算ロジックテスト

#### テストフィクスチャ
- `tests/Fixtures/03_sample/顧客管理データ.xlsx` - サンプル顧客管理データ
- `tests/Fixtures/03_sample/委託販売売上データ.xlsx` - サンプル売上データ
- `tests/Fixtures/03_sample/委託販売精算書.xlsx` - 精算書テンプレート（参考用）

### 5.4 実装した機能

#### Must要件の実装状況

1. **ファイルアップロード機能** ✅
   - 顧客管理データ（Excel）のアップロード
   - 委託販売売上データ（Excel）のアップロード
   - LivewireのWithFileUploadsトレイトを使用して実装

2. **データ自動変換機能** ✅
   - 顧客管理データと売上データの自動結合（クライアントIDをキーに）
   - 商品コードごとの売上データ集計
   - 精算書フォーマットへの自動レイアウト変換
   - 以下の計算を自動実行：
     - 小計（売上金額の合計）
     - 委託販売手数料（小計 × 手数料率）
     - 消費税（(小計 - 手数料) × 10%）
     - 振込手数料（固定：-440円）
     - お支払金額（小計 - 手数料 + 消費税 + 振込手数料）

3. **一括生成・ダウンロード機能** ✅
   - 全委託先分の精算書を一括生成
   - 各委託先ごとにシートを作成（シート名：クライアントID）
   - Excel形式（.xlsx）でダウンロード可能
   - 生成されたファイルは`storage/app/public/`に保存

### 5.5 Excelレイアウト仕様

#### 列幅設定
- A列：12.5（商品コード用）
- B列：28.33（商品名用）
- C列：11.67（単価用）
- D列：11.67（販売数用）
- E列：16.67（売上金額用）

#### セルスタイル
- **タイトル行（行1）**: 18pt、太字、ＭＳ Ｐゴシック、中央揃え
- **ヘッダー行（行16）**: 青色背景（#4A90E2）、白文字、太字、11pt、中央揃え、罫線
- **商品明細行（行17-26）**: 
  - 17-26行目は常に罫線と行の高さ（17.25）を設定
  - 商品データがない行も空白スペースとして確保
  - 数値は右揃え、カンマ区切りフォーマット
- **合計行（行27-31）**: 
  - 小計・手数料・税金・振込手数料行：灰色背景（#F0F0F0）、罫線
  - お支払金額行：青色背景（#4A90E2）、白文字、太字、罫線
- **お支払金額表示（C10-E12）**: 青色背景（#4A90E2）、白文字、20pt、太字、中央揃え

#### 固定レイアウト
- 17-26行目は商品データの有無に関わらず、常に罫線と行の高さを設定
- 合計行は常に27行目から開始（17-26行目は商品データ用のスペースとして確保）

### 5.6 データ構造

#### 顧客管理データ（Excel）の列構造
1. クライアントID
2. 事業者名
3. 郵便番号
4. 住所
5. 担当者名
6. 電話番号
7. FAX番号
8. メールアドレス
9. 手数料率（例：20%）
10. 契約開始日
11. 金融機関名
12. 支店名
13. 支店番号
14. 預金種目
15. 口座番号
16. 口座名義（カナ）
17. 備考

#### 売上データ（Excel）の列構造
1. 売上日
2. レシート番号
3. クライアントID
4. 事業者名
5. 商品コード
6. 商品名
7. 単価
8. 販売数
9. 売上金額
10. カテゴリ

### 5.7 テスト結果
すべてのテストが通過しています（5テスト、25アサーション）。

- ✅ 委託精算書一括発行ページが表示できる
- ✅ ファイルが選択されていない場合はエラーになる
- ✅ 顧客管理データと売上データから精算書を生成できる
- ✅ 顧客データと売上データを正しく結合できる
- ✅ 精算書の計算が正しい

### 5.8 今後の拡張予定（Could要件）
- 履歴保存機能（DBが必要）
- 過去分ダウンロード機能（DBが必要）
- PDF形式での出力機能
